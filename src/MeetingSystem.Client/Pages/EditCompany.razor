@page "/companies/{Id}/edit"
@using MeetingSystem.Client.Abstractions
@using MeetingSystem.Client.Models
@using MeetingSystem.Contracts.Companies

@inject ICompanyService CompanyService
@inject NavigationManager Nav
@inject NotificationService NotificationService
@inject DialogService DialogService 

<RadzenCard class="rz-my-12 rz-mx-auto rz-p-4 rz-p-md-12" style="max-width: 800px;">
    <RadzenText TextStyle="TextStyle.H3" Class="rz-mb-6">Edit Company</RadzenText>

    @if (isLoading)
    {
        <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
    }
    else
    {
        <RadzenTemplateForm TItem="CreateCompanyInputModel" Data="@inputModel" Submit="@OnSubmit">
            
            <RadzenStack Gap="1rem">
                <RadzenText TextStyle="TextStyle.H6" Class="rz-mt-4">General Information</RadzenText>

                <RadzenRow>
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenFormField Text="Company Name" Style="width: 100%;">
                            <ChildContent>
                                <RadzenTextBox Name="Name" @bind-Value="@inputModel.Name" />
                            </ChildContent>
                            <Helper>
                                <RadzenRequiredValidator Component="Name" Text="Company Name is required" />
                            </Helper>
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenStack Orientation="Orientation.Vertical" Gap="0.2rem">
                            <RadzenLabel Text="Image" Component="ImageUpload" style="color: var(--rz-text-tertiary-color); font-size: 0.75rem;" />
                            <RadzenUpload Name="ImageUpload" Auto="false" Multiple="false" Accept="image/*"
                                          Change="@OnImageChange"
                                          Style="width: 100%;" />
                            @if (selectedFile != null)
                            {
                                <RadzenText TextStyle="TextStyle.Caption">Selected: @selectedFile.Name</RadzenText>
                            }
                        </RadzenStack>
                    </RadzenColumn>
                </RadzenRow>

                <RadzenFormField Text="Description" Style="width: 100%;">
                    <ChildContent>
                        <RadzenTextArea Name="Description" @bind-Value="@inputModel.Description" Rows="3" />
                    </ChildContent>
                </RadzenFormField>

                <RadzenText TextStyle="TextStyle.H6" Class="rz-mt-4">Address Details</RadzenText>

                <RadzenRow>
                    <RadzenColumn Size="12" SizeMD="8">
                        <RadzenFormField Text="Street" Style="width: 100%;">
                            <ChildContent>
                                <RadzenTextBox Name="Street" @bind-Value="@inputModel.Street" />
                            </ChildContent>
                            <Helper>
                                <RadzenRequiredValidator Component="Street" Text="Street is required" />
                            </Helper>
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="4">
                        <RadzenFormField Text="Number" Style="width: 100%;">
                            <ChildContent>
                                <RadzenTextBox Name="Number" @bind-Value="@inputModel.Number" />
                            </ChildContent>
                            <Helper>
                                <RadzenRequiredValidator Component="Number" Text="Number is required" />
                            </Helper>
                        </RadzenFormField>
                    </RadzenColumn>
                </RadzenRow>

                <RadzenRow>
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenFormField Text="City" Style="width: 100%;">
                            <ChildContent>
                                <RadzenTextBox Name="City" @bind-Value="@inputModel.City" />
                            </ChildContent>
                            <Helper>
                                <RadzenRequiredValidator Component="City" Text="City is required" />
                            </Helper>
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenFormField Text="State" Style="width: 100%;">
                            <ChildContent>
                                <RadzenTextBox Name="State" @bind-Value="@inputModel.State" />
                            </ChildContent>
                            <Helper>
                                <RadzenRequiredValidator Component="State" Text="State is required" />
                            </Helper>
                        </RadzenFormField>
                    </RadzenColumn>
                </RadzenRow>

                @if (selectedFile == null && !string.IsNullOrEmpty(currentImageUrl))
                {
                    <RadzenText TextStyle="TextStyle.Caption">Current Image:</RadzenText>
                    <RadzenImage Path="@currentImageUrl" Style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;" />
                }

                @* --- BUTTONS SECTION --- *@
                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" Class="rz-mt-4">
                     <RadzenButton ButtonType="ButtonType.Submit" Text="Save Changes" IsBusy="@isBusy" Icon="save" ButtonStyle="ButtonStyle.Primary" />
                     
                     <RadzenButton Text="Delete Company" Icon="delete" ButtonStyle="ButtonStyle.Danger" Click="@OnDelete" IsBusy="@isBusy" />
                </RadzenStack>

            </RadzenStack>
        </RadzenTemplateForm>
    }
</RadzenCard>

@code {
    [Parameter] public string Id { get; set; } = string.Empty;

    CreateCompanyInputModel inputModel = new();

    IBrowserFile? selectedFile;
    bool isBusy = false;
    bool isLoading = true;
    string currentImageUrl = "";

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        var response = await CompanyService.GetCompanyByIdAsync(Id);

        if (response.IsSuccess)
        {
            var data = response.Data;

            inputModel.Name = data.Name;
            inputModel.Description = data.Description;
            inputModel.Street = data.Street;
            inputModel.Number = data.Number;
            inputModel.City = data.City;
            inputModel.State = data.State;

            if (!string.IsNullOrEmpty(data.ImageUrl))
            {
                currentImageUrl = $"http://localhost:8080/api/files/{data.ImageUrl}";
            }
        }
        else
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Could not load company.");
            Nav.NavigateTo($"/companies/{Id}");
        }
        isLoading = false;
    }

    void OnImageChange(UploadChangeEventArgs args)
    {
        if (args.Files.Any())
            selectedFile = args.Files.First();
        else
            selectedFile = null;
    }

    async Task OnSubmit(CreateCompanyInputModel args)
    {
        isBusy = true;

        var result = await CompanyService.UpdateCompanyAsync(Guid.Parse(Id), args, selectedFile);

        if (result.IsSuccess)
        {
            NotificationService.Notify(NotificationSeverity.Success, "Success", "Company updated!");
            Nav.NavigateTo($"/companies/{Id}");
        }
        else
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", result.Error.Description);
        }

        isBusy = false;
    }

    async Task OnDelete()
    {
        var confirmed = await DialogService.Confirm("Are you sure you want to delete this company? This cannot be undone.", "Delete Company", new ConfirmOptions() { OkButtonText = "Yes", CancelButtonText = "No" });

        if (confirmed == true)
        {
            isBusy = true;
            var result = await CompanyService.DeleteCompanyAsync(Guid.Parse(Id)); 

            if (result.IsSuccess)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Deleted", "Company deleted successfully.");
                Nav.NavigateTo("/companies"); 
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Cannot Delete", result.Error.Description);
            }
            isBusy = false;
        }
    }
}