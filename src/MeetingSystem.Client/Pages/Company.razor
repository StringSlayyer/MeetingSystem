@page "/companies/{Id}"
@using MeetingSystem.Client.Abstractions
@using MeetingSystem.Client.Auth
@using MeetingSystem.Contracts.Companies
@using Microsoft.AspNetCore.Components.Authorization
@using MeetingSystem.Client.Extensions

@inject ICompanyService CompanyService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav
@inject IJSRuntime JSRuntime

@if (!isLoaded)
{
    <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
}
else
{
    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" Class="rz-mb-4" AlignItems="AlignItems.Center">
        <RadzenButton Icon="arrow_back" Text="Back" ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Click="@GoBack" />

        @if (isOwner)
        {
            <RadzenButton Text="Edit Company" Icon="edit" ButtonStyle="ButtonStyle.Warning" Click="@EditCompany" />
        }
    </RadzenStack>

    <RadzenCard Variant="Variant.Outlined" Style="border-radius:16px;">
        @{
            bool hasImage = !string.IsNullOrEmpty(data.ImageUrl);
            string bgUrl = hasImage ? $"http://localhost:8080/api/files/{data.ImageUrl}" : "none";
            string bgColor = hasImage ? "transparent" : GetRandomColor(data.Name);
        }

        <RadzenCard Variant="Variant.Flat" Class="rz-mb-4 rz-mt-0"
                    Style="@($"height: 200px; background-size: cover; background-position: center; background-image: url('{bgUrl}'); background-color: {bgColor}; display: flex; align-items: center; justify-content: center;")">
            @if (!hasImage)
            {
                <RadzenIcon Icon="domain" Style="font-size: 80px; color: rgba(255,255,255,0.5);" />
            }
        </RadzenCard>

        <RadzenStack>
            <RadzenText TextStyle="TextStyle.H4" Text="@data.Name" Style="font-weight: bold; margin: 0;" />

            <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" Wrap="FlexWrap.Wrap">
                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                    <RadzenIcon Icon="location_on" Style="color: var(--rz-text-secondary-color);" />
                    <RadzenText TextStyle="TextStyle.Body1">@data.Street @data.Number, @data.City, @data.State</RadzenText>
                </RadzenStack>

                @if (data.Rating > 0)
                {
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                        <RadzenIcon Icon="star" Style="color: orange;" />
                        <RadzenText TextStyle="TextStyle.Body1">@data.Rating.ToString("0.0") / 5.0</RadzenText>
                    </RadzenStack>
                }
            </RadzenStack>

            <RadzenText Text="@data.Description" Class="rz-mt-2" />
        </RadzenStack>
    </RadzenCard>

    <RadzenStack class="rz-mt-8">
        <RadzenRow JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
            <RadzenText TextStyle="TextStyle.H5" Text="Available Resources" Style="margin: 0;" />
            @if (isOwner)
            {
                <RadzenButton Text="Add Resource" Icon="add" ButtonStyle="ButtonStyle.Success" Click="@AddResource" />
            }
        </RadzenRow>

        <RadzenRow Class="rz-mt-2">
            @if (data.Resources.Count > 0)
            {
                @foreach (var resource in data.Resources)
                {
                    <RadzenColumn Size="12" SizeMD="6" SizeLG="4">
                        <RadzenCard Style="cursor: pointer; height: 100%;" Class="rz-shadow-3 hover-effect" @onclick="@(() => OpenResource(resource.Id))">
                            <RadzenStack JustifyContent="JustifyContent.SpaceBetween" Style="height: 100%;">
                                <RadzenStack>
                                    <RadzenRow JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                        <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">@resource.Name</RadzenText>
                                        <RadzenBadge BadgeStyle="BadgeStyle.Light" Text="@($"{resource.Capacity} ppl")" />
                                    </RadzenRow>
                                    <RadzenText TextStyle="TextStyle.Body2" Class="rz-color-gray-dark">@resource.Description</RadzenText>
                                </RadzenStack>
                                <RadzenButton Text="View Calendar" ButtonStyle="ButtonStyle.Primary" Variant="Variant.Outlined" Size="ButtonSize.Small" Style="width: 100%; margin-top: 10px;" />
                            </RadzenStack>
                        </RadzenCard>
                    </RadzenColumn>
                }
            }
            else
            {
                <RadzenColumn Size="12">
                    <RadzenCard Variant="Variant.Flat" Class="rz-background-color-info-lighter rz-p-4" Style="text-align: center;">
                        <RadzenText TextStyle="TextStyle.Body1">No resources have been added yet.</RadzenText>
                    </RadzenCard>
                </RadzenColumn>
            }
        </RadzenRow>
    </RadzenStack>
}

@code {
    [Parameter] public string? Id { get; set; }

    public bool isLoaded = false;
    public bool isOwner = false;
    private SingleCompanyDTO? data;

    protected override async Task OnInitializedAsync()
    {
        isLoaded = false;
        var response = await CompanyService.GetCompanyByIdAsync(Id);

        if (response.IsSuccess)
        {
            data = response.Data;
        }
        else
        {
            Nav.NavigateTo("/companies"); 
            return;
        }

        var customProvider = (CustomAuthStateProvider)AuthStateProvider;
        var authState = await customProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            var currentUserId = user.GetUserId();
            isOwner = (currentUserId == data.Manager.ManagerId);
        }

        isLoaded = true;
    }

    string GetRandomColor(string name)
    {
        var colors = new[] { "#009688", "#2196f3", "#9c27b0", "#ff5722", "#607d8b" };
        return colors[Math.Abs(name.GetHashCode()) % colors.Length];
    }


    async Task GoBack()
    {
        Nav.NavigateTo("/companies");
    }

    void AddResource() => Nav.NavigateTo($"/companies/{data.Id}/resources/add");
    void OpenResource(Guid resourceId) => Nav.NavigateTo($"/resources/{resourceId}");
    void EditCompany() => Nav.NavigateTo($"/companies/{data.Id}/edit");
}