@page "/companies/{CompanyId}/resources/add"
@using MeetingSystem.Client.Abstractions
@using MeetingSystem.Client.Models
@using System.Globalization

@inject NotificationService NotificationService
@inject IResourceService ResourceService
@inject NavigationManager Nav

<RadzenCard class="rz-my-12 rz-mx-auto rz-p-4 rz-p-md-12" style="max-width: 800px;">
    <RadzenText TextStyle="TextStyle.H3" Class="rz-mb-6">Add New Resource</RadzenText>

    <RadzenTemplateForm TItem="AddResourceInputModel" Data="@inputModel" Submit="@OnSubmit">
        <RadzenStack Gap="1rem">

            <RadzenAlert Severity="AlertSeverity.Info" Variant="Variant.Flat" Shade="Shade.Lighter">
                Select the type of resource you are creating to see specific fields.
            </RadzenAlert>

            <RadzenFormField Text="Resource Type" Style="width: 100%;">
                <RadzenDropDown @bind-Value="inputModel.Type" 
                                Data="@(Enum.GetValues(typeof(ResourceType)))"
                                Name="ResourceType" />
            </RadzenFormField>

            <RadzenText TextStyle="TextStyle.H6" Class="rz-mt-4">General Information</RadzenText>

            <RadzenRow>
                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenFormField Text="Resource Name" Style="width: 100%;">
                        <ChildContent>
                            <RadzenTextBox Name="Name" @bind-Value="@inputModel.Name" />
                        </ChildContent>
                        <Helper>
                            <RadzenRequiredValidator Component="Name" Text="Name is required" />
                        </Helper>
                    </RadzenFormField>
                </RadzenColumn>
                
                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenStack Orientation="Orientation.Vertical" Gap="0.2rem">
                        <RadzenLabel Text="Resource Image" Component="ImageUpload" style="color: var(--rz-text-tertiary-color); font-size: 0.75rem;" />
                        <RadzenUpload Name="ImageUpload" Auto="false" Multiple="false" Accept="image/*"
                                      Change="@OnImageChange"
                                      Style="width: 100%;" />
                        @if (selectedFile != null)
                        {
                            <RadzenText TextStyle="TextStyle.Caption">Selected: @selectedFile.Name</RadzenText>
                        }
                    </RadzenStack>
                </RadzenColumn>
            </RadzenRow>

            <RadzenRow>
                 <RadzenColumn Size="12" SizeMD="6">
                    <RadzenFormField Text="Price Per Hour (CZK)" Style="width: 100%;">
                        <ChildContent>
                            <RadzenNumeric Name="Price" 
                                           @bind-Value="@inputModel.PricePerHour" 
                                           Format="c" 
                                           TValue="decimal"
                                           Culture="@(CultureInfo.GetCultureInfo("cs-CZ"))" />
                        </ChildContent>
                        <Helper>
                             <RadzenNumericRangeValidator Component="Price" Min="0.01" Text="Price must be greater than 0" />
                        </Helper>
                    </RadzenFormField>
                </RadzenColumn>
                 <RadzenColumn Size="12" SizeMD="6">
                    <RadzenFormField Text="Description" Style="width: 100%;">
                        <RadzenTextArea Name="Description" @bind-Value="@inputModel.Description" Rows="1" />
                    </RadzenFormField>
                </RadzenColumn>
            </RadzenRow>

            <RadzenHr />

            @if (inputModel.Type == ResourceType.MeetingRoom)
            {
                <RadzenText TextStyle="TextStyle.H6" Class="rz-color-primary">Meeting Room Details</RadzenText>
                <RadzenRow>
                    <RadzenColumn Size="12" SizeMD="4">
                        <RadzenFormField Text="Capacity (People)" Style="width: 100%;">
                            <RadzenNumeric @bind-Value="@inputModel.Capacity" Min="1" />
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="8">
                        <RadzenFormField Text="Features" Style="width: 100%;">
                            <ChildContent>
                                <RadzenTextBox Value="@inputModel.TempFeatureInput"
                                               @oninput="@OnFeatureInput"
                                               Style="width: 100%;"
                                               Placeholder="Type feature and press Comma (e.g. Wifi, )" />
                            </ChildContent>
                            <Helper>
                                <RadzenText TextStyle="TextStyle.Caption">Type text and press <b>Comma ( , )</b> to add.</RadzenText>
                            </Helper>
                        </RadzenFormField>

                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" Class="rz-mt-2" Wrap="FlexWrap.Wrap">
                            @foreach (var feature in inputModel.Features)
                            {
                                <RadzenBadge BadgeStyle="BadgeStyle.Light" IsPill="true" Class="rz-p-2" Style="cursor: pointer;">
                                    @feature
                                    <RadzenIcon Icon="close" Style="font-size: 0.8rem; margin-left: 5px;"
                                                @onclick="@(() => RemoveFeature(feature))" />
                                </RadzenBadge>
                            }
                        </RadzenStack>
                    </RadzenColumn>
                </RadzenRow>
            }
            else if (inputModel.Type == ResourceType.ParkingSpot)
            {
                <RadzenText TextStyle="TextStyle.H6" Class="rz-color-primary">Parking Details</RadzenText>
                <RadzenStack>
                   
                        <RadzenLabel Text="Is Covered?" Class="rz-mr-2"/>
                        <RadzenCheckBox @bind-Value="@inputModel.IsCovered" />
                </RadzenStack>
            }

            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Class="rz-mt-4">
                <RadzenButton ButtonType="ButtonType.Submit" Text="Create Resource" IsBusy="@isBusy" Icon="save" />
            </RadzenStack>

        </RadzenStack>
    </RadzenTemplateForm>
</RadzenCard>

@code {
    [Parameter] public string CompanyId { get; set; }

    AddResourceInputModel inputModel = new();
    IBrowserFile? selectedFile;
    bool isBusy = false;
    string errorMessage = "";

    protected override void OnInitialized()
    {
        if(Guid.TryParse(CompanyId, out Guid gId))
        {
            inputModel.CompanyId = gId;
        }
    }

    void OnImageChange(UploadChangeEventArgs args)
    {
        if (args.Files.Any())
            selectedFile = args.Files.First();
        else
            selectedFile = null;
    }

    async Task OnSubmit()
    {
        isBusy = true;

        if (inputModel.Type == ResourceType.ParkingSpot)
        {
            inputModel.Capacity = 1; 
        }

        var result = await ResourceService.AddResourceAsync(inputModel, selectedFile);


        if (result.IsSuccess)
        {
            Nav.NavigateTo($"/resources/{result.Data}");
        }
        else
        {
            errorMessage = result.Error.Description;
        }

        isBusy = false;
    }

    void OnFeatureInput(ChangeEventArgs args)
    {
        string val = args.Value?.ToString() ?? "";

        if (val.Contains(","))
        {
            var newFeatures = val.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries)
                                 .Select(f => f.Trim())
                                 .Where(f => !string.IsNullOrEmpty(f));

            foreach (var f in newFeatures)
            {
                if (!inputModel.Features.Contains(f))
                {
                    inputModel.Features.Add(f);
                }
            }

            inputModel.TempFeatureInput = "";
        }
        else
        {
            inputModel.TempFeatureInput = val;
        }
    }

    

    void RemoveFeature(string feature)
    {
        inputModel.Features.Remove(feature);
    }
}