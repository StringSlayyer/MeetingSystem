@page "/resources/{Id}"
@using MeetingSystem.Client.Abstractions
@using MeetingSystem.Client.Auth
@using MeetingSystem.Client.Extensions
@using MeetingSystem.Contracts.Reservations
@using MeetingSystem.Contracts.Resources
@using Microsoft.AspNetCore.Components.Authorization
@using System.Globalization

@inject IResourceService ResourceService
@inject IReservationService ReservationService
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JSRuntime
@inject NavigationManager Nav

@if (resource == null && isLoading)
{
    <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
}
else if (resource != null)
{
    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center" Class="rz-mb-4">
        <RadzenButton Icon="arrow_back" Text="Back to Company" 
                      ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" 
                      Click="@(() => Nav.NavigateTo($"/companies/{resource.CompanyId}"))" />

        @if (isOwner)
        {
            <RadzenButton Text="Edit Resource" Icon="edit" ButtonStyle="ButtonStyle.Warning" Click="@NavigateToEdit" />
        }
    </RadzenStack>

    
        bool hasImage = !string.IsNullOrEmpty(resource.ImageUrl);
        string bgUrl = hasImage ? $"http://localhost:8080/api/files/{resource.ImageUrl}" : "none";
    

    <RadzenCard Variant="Variant.Flat" Class="rz-mb-4 rz-mt-0"
                Style="@($"height: 250px; border-radius: 16px; background-size: cover; background-position: center; background-image: url('{bgUrl}'); background-color: #f3f4f6; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden;")">
        
        @if (!hasImage)
        {
             <RadzenIcon Icon="@(resource is MeetingRoomDTO ? "meeting_room" : "local_parking")" Style="font-size: 80px; color: #d1d5db;" />
        }
    </RadzenCard>

    <RadzenCard Variant="Variant.Outlined" Class="rz-mb-4" Style="border-radius: 16px;">
        <RadzenRow AlignItems="AlignItems.Start" JustifyContent="JustifyContent.SpaceBetween">
            
            <RadzenColumn Size="12" SizeMD="8">
                <RadzenStack Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.H3" Style="font-weight: 800; margin: 0; color: var(--rz-primary);">@resource.Name</RadzenText>
                    
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center">
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.2rem" AlignItems="AlignItems.Center">
                            <RadzenIcon Icon="@(resource is MeetingRoomDTO ? "meeting_room" : "local_parking")" Style="color: var(--rz-text-secondary-color);" />
                            <RadzenText TextStyle="TextStyle.Body1" Style="font-weight: 600;">
                                @(resource is MeetingRoomDTO ? "Meeting Room" : "Parking Spot")
                            </RadzenText>
                        </RadzenStack>

                        @if(resource is MeetingRoomDTO room)
                        {
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.2rem" AlignItems="AlignItems.Center">
                                <RadzenIcon Icon="groups" Style="color: var(--rz-text-secondary-color);" />
                                <RadzenText TextStyle="TextStyle.Body1">Capacity: @room.Capacity</RadzenText>
                            </RadzenStack>
                        }
                    </RadzenStack>

                    <RadzenText TextStyle="TextStyle.Body1" Class="rz-mt-2" Style="color: var(--rz-text-secondary-color);">
                        @resource.Description
                    </RadzenText>

                    @if (resource is MeetingRoomDTO roomDTO && roomDTO.Features.Any())
                    {
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" Wrap="FlexWrap.Wrap" Class="rz-mt-2">
                            @foreach (var feature in roomDTO.Features)
                            {
                                <RadzenBadge BadgeStyle="BadgeStyle.Info" IsPill="true" Text="@feature" Class="rz-p-2" />
                            }
                        </RadzenStack>
                    }
                    else if (resource is ParkingSpotDTO spot)
                    {
                         <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" Class="rz-mt-2">
                             <RadzenBadge BadgeStyle="@(spot.IsCovered ? BadgeStyle.Success : BadgeStyle.Warning)" 
                                          IsPill="true" 
                                          Text="@(spot.IsCovered ? "Covered Roof" : "Open Sky")" 
                                          Class="rz-p-2" />
                         </RadzenStack>
                    }
                </RadzenStack>
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="4" Class="rz-text-align-right">
                <RadzenCard Variant="Variant.Flat" Class="rz-background-color-success-lighter" Style="display: inline-block; padding: 1rem 2rem;">
                    <RadzenText TextStyle="TextStyle.Overline" Class="rz-color-success-dark" Style="margin: 0;">Price per Hour</RadzenText>
                    <RadzenText TextStyle="TextStyle.H4" Class="rz-color-success-dark" Style="margin: 0; font-weight: bold;">
                        @resource.PricePerHour.ToString("C", CultureInfo.GetCultureInfo("cs-CZ"))
                    </RadzenText>
                </RadzenCard>
            </RadzenColumn>

        </RadzenRow>
    </RadzenCard>

    <RadzenCard Style="border-radius: 16px;">
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem" Class="rz-mb-4">
            <RadzenIcon Icon="calendar_month" />
            <RadzenText TextStyle="TextStyle.H5" Style="margin: 0;">Availability Calendar</RadzenText>
        </RadzenStack>

        <RadzenScheduler @ref=@scheduler
                         SlotRender="@OnSlotRender"
                         Style="height: 700px;"
                         TItem="ReservationDTO"
                         Data="@reservations"
                         StartProperty="Start"
                         EndProperty="End"
                         TextProperty="Status"
                         LoadData="@OnLoadData"
                         SlotSelect="@OnSlotSelect"
                         AppointmentSelect="@OnAppointmentSelect"
                         AppointmentRender="@OnAppointmentRender">

            <RadzenDayView StartTime="TimeSpan.FromHours(0)" EndTime="TimeSpan.FromHours(24)" />
            <RadzenWeekView StartTime="TimeSpan.FromHours(0)" EndTime="TimeSpan.FromHours(24)" />
            <RadzenMonthView />
        </RadzenScheduler>
    </RadzenCard>
}

@code {
    [Parameter] public string Id { get; set; }

    bool isLoading = true;
    RadzenScheduler<ReservationDTO> scheduler;
    ResourceDTO? resource;
    IList<ReservationDTO> reservations = new List<ReservationDTO>();
    Guid UserId = Guid.Empty;
    bool isOwner = false;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        if (Guid.TryParse(Id, out var resourceId))
        {
            Console.WriteLine($"Parsed guid {resourceId}");
            var result = await ResourceService.GetResourceByIdAsync(new(resourceId));
            await JSRuntime.InvokeVoidAsync("console.log", "Result error from request ", result.Error);
            await JSRuntime.InvokeVoidAsync("console.log", "Result data from request ", result.Data);
            await JSRuntime.InvokeVoidAsync("console.log", "Result from request ", result);
            Console.WriteLine(result.Error);
            Console.WriteLine(result.Data);
            Console.WriteLine(result);

            if (result.IsSuccess)
            {
                Console.WriteLine(result);
                resource = result.Data;
                
            }
            else
            {
                Console.WriteLine(result.Error);
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Resource not found");
            }
        }

        var customProvider = (CustomAuthStateProvider)AuthStateProvider;
        var authState = await customProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            UserId = user.GetUserId();
            if (UserId != Guid.Empty && resource.ManagerId == UserId)
            {
                isOwner = true;
            }

        }
        isLoading = false;
    }

    async Task OnLoadData(SchedulerLoadDataEventArgs args)
    {
        if (Guid.TryParse(Id, out var resourceId))
        {
            var result = await ReservationService.GetReservationsByResourceAsync(new(resourceId, args.Start, args.End));
            await JSRuntime.InvokeVoidAsync("console.log", "Result error from request ", result.Error);
            await JSRuntime.InvokeVoidAsync("console.log", "Result data from request ", result.Data);
            await JSRuntime.InvokeVoidAsync("console.log", "Result from request ", result);
            if (result.IsSuccess)
            {
                reservations = result.Data.Select(r => r with
                {
                    Start = r.Start.ToLocalTime(),
                    End = r.End.ToLocalTime()
                }).ToList();
            }
        }
    }

    async Task OnSlotSelect(SchedulerSlotSelectEventArgs args)
    {
        if (args.Start < DateTime.Now)
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Cannot book past dates");
            return;
        }

        var data = await DialogService.OpenAsync<AddReservationDialog>("New Reservation",
            new Dictionary<string, object> { { "Start", args.Start }, { "End", args.End }, { "ResourceId", resource.Id } });

        if (data == true)
        {
            await scheduler.Reload(); 
        }
    }

    async Task OnAppointmentSelect(SchedulerAppointmentSelectEventArgs<ReservationDTO> args)
    {
        await DialogService.OpenAsync<ReservationDetailDialog>("Reservation Details",
             new Dictionary<string, object>
             {
                 { "Reservation", args.Data },
                 { "CurrentUserId", UserId },
                 { "IsResourceOwner", isOwner }
             });

        await scheduler.Reload();
    }

    void OnAppointmentRender(SchedulerAppointmentRenderEventArgs<ReservationDTO> args)
    {
        
        if (args.Data.UserId == UserId) 
        {
            args.Attributes["style"] = "background: #009688"; 
        }

        args.Attributes["draggable"] = "false";
    }

    void OnSlotRender(SchedulerSlotRenderEventArgs args)
    {
        if (args.View.Text == "Month" && args.Start.Date == DateTime.Today)
        {
            args.Attributes["style"] = "background: rgba(255,220,40,0.2);";
        }
    }

    void NavigateToEdit()
    {
        Nav.NavigateTo($"/resources/{Id}/edit");
    }

    string GetImageUrl(ResourceDTO r) =>
      string.IsNullOrEmpty(r.ImageUrl) ? "none" : $"http://localhost:8080/api/files/{r.ImageUrl}";
}